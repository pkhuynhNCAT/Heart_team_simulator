<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Team Simulator - Advanced Mitral Valve Decision Making</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --dark-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --card-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            --card-hover-shadow: 0 30px 80px rgba(0, 0, 0, 0.25);
            --system-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--system-font);
            background: #0a0e27;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            font-weight: 400;
        }

        /* Typography Enhancement for System Fonts */
        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .font-light { font-weight: 300; }
        .font-regular { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-extrabold { font-weight: 800; }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            overflow: hidden;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        .animated-bg::after {
            content: '';
            position: absolute;
            bottom: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(118, 75, 162, 0.1) 0%, transparent 70%);
            animation: rotate 40s linear infinite reverse;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Particle Effects */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-gradient);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .welcome-content {
            max-width: 1200px;
            padding: 60px;
            text-align: center;
            animation: welcomeFadeIn 1s ease;
        }

        @keyframes welcomeFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            background: var(--primary-gradient);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: white;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 30px 80px rgba(102, 126, 234, 0.6);
            }
        }

        .welcome-title {
            font-size: 3.5em;
            font-weight: 800;
            color: white;
            margin-bottom: 20px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .welcome-subtitle {
            font-size: 1.3em;
            color: #8892b0;
            margin-bottom: 50px;
            font-weight: 300;
        }

        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            background: var(--primary-gradient);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
        }

        .feature-title {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .feature-description {
            color: #8892b0;
            line-height: 1.6;
        }

        .start-button {
            padding: 20px 60px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 60px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.5);
        }

        /* Main Application */
        .main-app {
            display: none;
            min-height: 100vh;
            position: relative;
        }

        /* Header */
        .app-header {
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 40px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .logo-badge {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.3em;
        }

        .logo-text {
            color: white;
            font-size: 1.3em;
            font-weight: 600;
        }

        .mode-badge {
            padding: 8px 20px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            color: #667eea;
            font-weight: 500;
            font-size: 0.9em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .timer-display {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timer-icon {
            color: #667eea;
        }

        .case-progress {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .progress-label {
            color: #8892b0;
            font-size: 0.9em;
        }

        .progress-value {
            color: white;
            font-weight: 600;
        }

        /* Main Layout */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
        }

        /* Patient Information Panel */
        .patient-panel {
            background: rgba(26, 31, 58, 0.95);
            border-radius: 24px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: fit-content;
            position: sticky;
            top: 110px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .patient-header {
            margin-bottom: 30px;
        }

        .patient-photo {
            width: 80px;
            height: 80px;
            background: var(--primary-gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .patient-name {
            color: white;
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .patient-meta {
            display: flex;
            gap: 15px;
            color: #8892b0;
            font-size: 0.95em;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Data Sections */
        .data-section {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 28px;
            height: 28px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
        }

        .section-expand {
            cursor: pointer;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .section-expand:hover {
            transform: scale(1.2);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .data-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .data-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .data-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .data-item:hover::before {
            left: 100%;
        }

        .data-label {
            color: #8892b0;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .data-value {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
        }

        .data-value.normal {
            color: #11998e;
        }

        .data-value.warning {
            color: #ffa726;
        }

        .data-value.critical {
            color: #ef5350;
        }

        .data-unit {
            color: #8892b0;
            font-size: 0.8em;
            font-weight: 400;
            margin-left: 3px;
        }

        .data-trend {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #8892b0;
            font-size: 0.8em;
        }

        .trend-up {
            color: #ef5350;
        }

        .trend-down {
            color: #11998e;
        }

        /* Status Badges */
        .status-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .status-badge.active {
            background: rgba(239, 83, 80, 0.2);
            border-color: rgba(239, 83, 80, 0.3);
            color: #ef5350;
        }

        .status-badge.inactive {
            background: rgba(17, 153, 142, 0.2);
            border-color: rgba(17, 153, 142, 0.3);
            color: #11998e;
        }

        /* Conference Room */
        .conference-room {
            background: rgba(26, 31, 58, 0.95);
            border-radius: 24px;
            padding: 40px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .room-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .room-title {
            color: white;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .room-subtitle {
            color: #8892b0;
        }

        /* Interactive Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .action-btn {
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .action-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .action-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        /* Team Circle */
        .team-circle {
            position: relative;
            width: 100%;
            height: 450px;
            margin-bottom: 40px;
        }

        .circle-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .circle-center:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: translate(-50%, -50%) scale(1.05);
        }

        .center-label {
            color: #8892b0;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .center-value {
            color: white;
            font-size: 2em;
            font-weight: 700;
        }

        .center-status {
            color: #667eea;
            font-size: 0.9em;
            margin-top: 10px;
        }

        /* Team Members */
        .team-member {
            position: absolute;
            width: 140px;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .member-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
        }

        .member-avatar:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .member-avatar.speaking {
            animation: speakingPulse 2s ease infinite;
            border-color: #667eea;
            box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
        }

        @keyframes speakingPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .member-avatar.agrees {
            border-color: #11998e;
            background: rgba(17, 153, 142, 0.1);
        }

        .member-avatar.disagrees {
            border-color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }

        .member-avatar.thinking {
            border-color: #ffa726;
            background: rgba(255, 167, 38, 0.1);
        }

        .member-avatar.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
        }

        .member-emoji {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .member-role {
            font-size: 0.75em;
            color: #8892b0;
            text-align: center;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .member-name {
            color: white;
            font-size: 0.9em;
            font-weight: 500;
            margin-top: 10px;
            text-align: center;
        }

        .member-status {
            font-size: 0.8em;
            color: #8892b0;
            text-align: center;
            margin-top: 5px;
        }

        .opinion-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9em;
            border: 2px solid rgba(26, 31, 58, 1);
            transition: all 0.3s ease;
        }

        .opinion-surgery {
            background: var(--danger-gradient);
        }

        .opinion-transcatheter {
            background: var(--info-gradient);
        }

        .opinion-medical {
            background: var(--warning-gradient);
        }

        .opinion-undecided {
            background: linear-gradient(135deg, #757575 0%, #424242 100%);
        }

        /* Member Tooltip */
        .member-tooltip {
            position: absolute;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .member-avatar:hover .member-tooltip {
            opacity: 1;
        }

        /* Discussion Area */
        .discussion-area {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            max-height: 500px;
            overflow-y: auto;
        }

        .discussion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .discussion-title {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(239, 83, 80, 0.2);
            border-radius: 20px;
            color: #ef5350;
            font-size: 0.85em;
            font-weight: 500;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ef5350;
            border-radius: 50%;
            animation: livePulse 2s ease infinite;
        }

        @keyframes livePulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .discussion-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #8892b0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            opacity: 0;
            animation: messageSlide 0.5s ease forwards;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .message-avatar.surgeon {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .message-avatar.interventional {
            background: var(--info-gradient);
        }

        .message-avatar.imaging {
            background: var(--success-gradient);
        }

        .message-avatar.anesthesia {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .message-avatar.heartfailure {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
        }

        .message-avatar.coordinator {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-sender {
            color: white;
            font-weight: 600;
        }

        .message-role {
            color: #8892b0;
            font-size: 0.85em;
        }

        .message-time {
            color: #8892b0;
            font-size: 0.8em;
            margin-left: auto;
        }

        .message-text {
            color: #ccd6f6;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 12px;
            border-left: 3px solid;
        }

        .message-text.support {
            border-left-color: #11998e;
        }

        .message-text.challenge {
            border-left-color: #ef5350;
        }

        .message-text.neutral {
            border-left-color: #667eea;
        }

        .message-text.question {
            border-left-color: #ffa726;
        }

        .message-reactions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .reaction-btn {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: #8892b0;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .reaction-btn.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        .message-highlight {
            background: rgba(102, 126, 234, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .highlight-label {
            color: #667eea;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .highlight-text {
            color: white;
            font-weight: 500;
        }

        /* Interactive Controls */
        .interaction-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .your-turn {
            background: var(--success-gradient);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 20px;
            animation: turnGlow 2s ease infinite;
        }

        @keyframes turnGlow {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(17, 153, 142, 0.3);
            }
            50% {
                box-shadow: 0 5px 30px rgba(17, 153, 142, 0.5);
            }
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-action {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .quick-action-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .quick-action-label {
            color: #8892b0;
            font-size: 0.85em;
        }

        .response-options {
            display: grid;
            gap: 15px;
        }

        .response-option {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .response-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .response-option:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .response-option:hover::before {
            left: 100%;
        }

        .response-option.selected {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .response-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-support {
            background: rgba(17, 153, 142, 0.2);
            color: #11998e;
        }

        .type-challenge {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }

        .type-question {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .type-data {
            background: rgba(255, 167, 38, 0.2);
            color: #ffa726;
        }

        .response-text {
            color: #ccd6f6;
            line-height: 1.6;
        }

        .response-confidence {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .confidence-label {
            color: #8892b0;
            font-size: 0.85em;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--primary-gradient);
            transition: width 0.3s ease;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Consensus Meter */
        .consensus-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .consensus-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .consensus-title {
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consensus-value {
            color: #667eea;
            font-size: 1.5em;
            font-weight: 700;
        }

        .consensus-bar {
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .consensus-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef5350 0%, #ffa726 40%, #66bb6a 80%, #11998e 100%);
            border-radius: 20px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .consensus-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 0 10px;
        }

        .consensus-marker {
            color: #8892b0;
            font-size: 0.85em;
        }

        /* Vote Distribution */
        .vote-distribution {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .vote-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .vote-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-3px);
        }

        .vote-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .vote-icon.surgery {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }

        .vote-icon.transcatheter {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
        }

        .vote-icon.medical {
            background: rgba(255, 167, 38, 0.2);
            color: #ffa726;
        }

        .vote-count {
            color: white;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .vote-label {
            color: #8892b0;
            font-size: 0.85em;
        }

        .vote-members {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        .vote-member-mini {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
        }

        /* Decision Tree Visualization */
        .decision-tree {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .tree-header {
            color: white;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tree-nodes {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tree-node {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border-left: 3px solid;
            transition: all 0.3s ease;
        }

        .tree-node:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .node-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .node-content {
            flex: 1;
        }

        .node-title {
            color: white;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .node-description {
            color: #8892b0;
            font-size: 0.9em;
        }

        .node-value {
            color: #667eea;
            font-weight: 600;
            font-size: 1.1em;
        }

        /* Decision Summary Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            z-index: 2000;
            backdrop-filter: blur(10px);
            animation: modalFade 0.3s ease;
        }

        @keyframes modalFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%);
            border-radius: 24px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.5);
            animation: modalSlide 0.4s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: var(--success-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            color: white;
            box-shadow: 0 10px 40px rgba(17, 153, 142, 0.3);
        }

        .modal-title {
            color: white;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #8892b0;
            font-size: 1.1em;
        }

        .score-display {
            font-size: 4em;
            font-weight: 800;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        .feedback-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .feedback-title {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feedback-content {
            color: #ccd6f6;
            line-height: 1.8;
        }

        .learning-points {
            list-style: none;
            padding: 0;
        }

        .learning-point {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }

        .point-icon {
            width: 24px;
            height: 24px;
            background: var(--success-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            font-size: 0.8em;
        }

        .point-text {
            color: #ccd6f6;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-btn.primary {
            background: var(--primary-gradient);
            color: white;
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Loading States */
        .thinking-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 10px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: thinking 1.4s ease infinite;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 1;
            }
            30% {
                transform: translateY(-10px);
                opacity: 0.6;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .app-container {
                grid-template-columns: 350px 1fr;
            }
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .patient-panel {
                position: relative;
                top: 0;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2.5em;
            }
            
            .feature-cards {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .vote-distribution {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    <div class="particles" id="particles"></div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-logo">‚ù§Ô∏è</div>
            <h1 class="welcome-title">Heart Team Simulator</h1>
            <p class="welcome-subtitle">Master Mitral Valve Decision-Making Through Immersive Team Discussions</p>
            
            <div class="feature-cards">
                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <div class="feature-title">Realistic Scenarios</div>
                    <div class="feature-description">Experience authentic heart team dynamics with complex clinical cases</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üí¨</div>
                    <div class="feature-title">Interactive Discussions</div>
                    <div class="feature-description">Participate in real-time debates and witness professional disagreements</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üß†</div>
                    <div class="feature-title">Evidence-Based Learning</div>
                    <div class="feature-description">Learn from detailed explanations backed by current guidelines</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <div class="feature-title">Comprehensive Data</div>
                    <div class="feature-description">Analyze complete patient information including echo, labs, and risk scores</div>
                </div>
            </div>
            
            <button class="start-button" onclick="startApplication()">Begin Simulation</button>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <!-- Header -->
        <div class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo-badge">
                        <div class="logo-icon">HT</div>
                        <div class="logo-text">Heart Team Conference</div>
                    </div>
                    <div class="mode-badge" id="modeBadge">Guided Learning</div>
                </div>
                <div class="header-right">
                    <div class="timer-display">
                        <span class="timer-icon">‚è±Ô∏è</span>
                        <span id="timerValue">00:00</span>
                    </div>
                    <div class="case-progress">
                        <span class="progress-label">Case</span>
                        <span class="progress-value" id="caseNumber">1 of 5</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="app-container">
            <!-- Patient Information Panel -->
            <div class="patient-panel" id="patientPanel">
                <!-- Patient data will be dynamically loaded -->
            </div>

            <!-- Conference Room -->
            <div class="conference-room">
                <div class="room-header">
                    <h2 class="room-title">Multidisciplinary Heart Team Conference</h2>
                    <p class="room-subtitle">Real-time collaborative decision making for optimal patient care</p>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn active" onclick="setView('discussion')">üí¨ Discussion</button>
                    <button class="action-btn" onclick="setView('voting')">üó≥Ô∏è Voting</button>
                    <button class="action-btn" onclick="setView('evidence')">üìö Evidence</button>
                    <button class="action-btn" onclick="setView('decision')">üéØ Decision Tree</button>
                </div>

                <!-- Team Circle Visualization -->
                <div class="team-circle" id="teamCircle">
                    <div class="circle-center" onclick="showConsensusDetails()">
                        <div class="center-label">Consensus Level</div>
                        <div class="center-value" id="consensusPercent">0%</div>
                        <div class="center-status" id="consensusStatus">Building...</div>
                    </div>
                    <!-- Team members will be dynamically added here -->
                </div>

                <!-- Discussion Area -->
                <div class="discussion-area" id="discussionArea">
                    <div class="discussion-header">
                        <div class="discussion-title">
                            <span>üí¨</span>
                            <span>Team Discussion</span>
                        </div>
                        <div class="discussion-controls">
                            <button class="control-btn" onclick="pauseDiscussion()" title="Pause">‚è∏Ô∏è</button>
                            <button class="control-btn" onclick="speedUpDiscussion()" title="Speed Up">‚è©</button>
                            <button class="control-btn" onclick="jumpToConflict()" title="Jump to Conflict">‚ö°</button>
                        </div>
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>LIVE</span>
                        </div>
                    </div>
                    <div id="discussionMessages">
                        <!-- Messages will be dynamically added here -->
                    </div>
                </div>

                <!-- Interaction Panel (for Practice Mode) -->
                <div class="interaction-panel" id="interactionPanel" style="display: none;">
                    <div class="your-turn" id="yourTurn" style="display: none;">
                        üéØ It's Your Turn to Contribute
                    </div>
                    
                    <div class="quick-actions">
                        <div class="quick-action" onclick="quickAction('agree')">
                            <div class="quick-action-icon">üëç</div>
                            <div class="quick-action-label">Agree</div>
                        </div>
                        <div class="quick-action" onclick="quickAction('disagree')">
                            <div class="quick-action-icon">üëé</div>
                            <div class="quick-action-label">Disagree</div>
                        </div>
                        <div class="quick-action" onclick="quickAction('question')">
                            <div class="quick-action-icon">‚ùì</div>
                            <div class="quick-action-label">Question</div>
                        </div>
                        <div class="quick-action" onclick="quickAction('data')">
                            <div class="quick-action-icon">üìä</div>
                            <div class="quick-action-label">Present Data</div>
                        </div>
                    </div>
                    
                    <div class="response-options" id="responseOptions">
                        <!-- Options will be dynamically added -->
                    </div>
                    <button class="submit-btn" id="submitBtn" onclick="submitResponse()" disabled>
                        Submit Response
                    </button>
                </div>

                <!-- Consensus Panel -->
                <div class="consensus-panel" id="consensusPanel">
                    <div class="consensus-header">
                        <div class="consensus-title">
                            <span>ü§ù</span>
                            <span>Team Consensus Progress</span>
                        </div>
                        <div class="consensus-value" id="consensusValue">0%</div>
                    </div>
                    <div class="consensus-bar">
                        <div class="consensus-fill" id="consensusFill" style="width: 0%;">
                            Building Consensus...
                        </div>
                    </div>
                    <div class="consensus-markers">
                        <span class="consensus-marker">Disagreement</span>
                        <span class="consensus-marker">Discussion</span>
                        <span class="consensus-marker">Alignment</span>
                        <span class="consensus-marker">Consensus</span>
                    </div>
                    
                    <div class="vote-distribution" id="voteDistribution">
                        <!-- Vote cards will be dynamically added -->
                    </div>
                </div>

                <!-- Decision Tree (hidden by default) -->
                <div class="decision-tree" id="decisionTree" style="display: none;">
                    <div class="tree-header">
                        <span>üå≥</span>
                        <span>Clinical Decision Pathway</span>
                    </div>
                    <div class="tree-nodes" id="treeNodes">
                        <!-- Decision nodes will be dynamically added -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal" id="feedbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">‚úÖ</div>
                <h2 class="modal-title" id="modalTitle">Case Complete!</h2>
                <p class="modal-subtitle" id="modalSubtitle">Let's review the team's decision and key learning points</p>
                <div class="score-display" id="scoreDisplay">92%</div>
            </div>

            <div class="feedback-section">
                <div class="feedback-title">
                    <span>üéØ</span>
                    <span>Final Team Decision</span>
                </div>
                <div class="feedback-content" id="finalDecision">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="feedback-section">
                <div class="feedback-title">
                    <span>üìã</span>
                    <span>Clinical Rationale</span>
                </div>
                <div class="feedback-content" id="clinicalRationale">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="feedback-section">
                <div class="feedback-title">
                    <span>üí°</span>
                    <span>Key Learning Points</span>
                </div>
                <ul class="learning-points" id="learningPoints">
                    <!-- Will be populated dynamically -->
                </ul>
            </div>

            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="reviewCase()">Review Discussion</button>
                <button class="modal-btn primary" onclick="nextCase()">Next Case</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Enhanced Clinical Cases Database
        const casesDatabase = [
            {
                id: 1,
                patient: {
                    name: "Robert Johnson",
                    age: 68,
                    gender: "Male",
                    photo: "RJ",
                    presenting: "Progressive dyspnea on exertion over 6 months, now NYHA Class II"
                },
                clinicalData: {
                    hemodynamics: {
                        ef: { value: 62, trend: 'stable' },
                        lvedv: { value: 185, trend: 'up' },
                        lvesv: { value: 70, trend: 'stable' },
                        la_volume: { value: 95, trend: 'up' },
                        pap: { value: 38, trend: 'stable' },
                        ci: { value: 3.2, trend: 'stable' }
                    },
                    valve: {
                        mr_severity: "Severe",
                        mechanism: "P2 Prolapse",
                        ero: 0.45,
                        reg_volume: 65,
                        tr_severity: "Mild",
                        annulus: 38,
                        leaflet_thickness: "Normal",
                        calcification: "None"
                    },
                    risk: {
                        sts: 1.8,
                        euroscore: 2.1,
                        creatinine: 1.1,
                        hemoglobin: 13.5,
                        frailty_index: 0.12
                    },
                    status: {
                        nyha: "II",
                        diabetes: true,
                        cad: false,
                        afib: false,
                        copd: false,
                        prior_surgery: false
                    },
                    imaging: {
                        echo_quality: "Excellent",
                        tee_performed: true,
                        ct_performed: true,
                        mri_performed: false
                    }
                },
                teamMembers: [
                    {
                        id: "surgeon",
                        name: "Dr. Michael Chen",
                        role: "Cardiac Surgeon",
                        emoji: "üë®‚Äç‚öïÔ∏è",
                        position: { angle: 0 },
                        opinion: "surgery",
                        confidence: 95,
                        personality: "confident",
                        experience: "20 years, 500+ mitral repairs"
                    },
                    {
                        id: "interventional",
                        name: "Dr. Sarah Williams", 
                        role: "Interventional",
                        emoji: "üë©‚Äç‚öïÔ∏è",
                        position: { angle: 60 },
                        opinion: "undecided",
                        confidence: 60,
                        personality: "analytical",
                        experience: "15 years, 300+ MitraClip procedures"
                    },
                    {
                        id: "imaging",
                        name: "Dr. James Park",
                        role: "Imaging Specialist",
                        emoji: "üë®‚Äç‚öïÔ∏è",
                        position: { angle: 120 },
                        opinion: "surgery",
                        confidence: 90,
                        personality: "detail-oriented",
                        experience: "18 years cardiac imaging"
                    },
                    {
                        id: "anesthesia",
                        name: "Dr. Linda Brown",
                        role: "Anesthesiologist",
                        emoji: "üë©‚Äç‚öïÔ∏è",
                        position: { angle: 180 },
                        opinion: "surgery",
                        confidence: 85,
                        personality: "cautious",
                        experience: "22 years cardiac anesthesia"
                    },
                    {
                        id: "heartfailure",
                        name: "Dr. Robert Martinez",
                        role: "HF Specialist",
                        emoji: "üë®‚Äç‚öïÔ∏è",
                        position: { angle: 240 },
                        opinion: "surgery",
                        confidence: 88,
                        personality: "evidence-based",
                        experience: "16 years heart failure management"
                    },
                    {
                        id: "coordinator",
                        name: "Patricia Anderson",
                        role: "Nurse Coordinator",
                        emoji: "üë©‚Äç‚öïÔ∏è",
                        position: { angle: 300 },
                        opinion: "undecided",
                        confidence: 70,
                        personality: "patient-focused",
                        experience: "12 years cardiac care coordination"
                    }
                ],
                discussion: [
                    {
                        speaker: "surgeon",
                        message: "Good morning everyone. We're discussing Mr. Johnson, a 68-year-old with severe symptomatic MR. Looking at the echo findings, this appears to be an excellent surgical candidate with isolated P2 prolapse.",
                        type: "neutral",
                        reactions: [],
                        delay: 2000
                    },
                    {
                        speaker: "imaging",
                        message: "I agree. The 3D TEE shows isolated P2 prolapse with a 7mm flail gap. The leaflet tissue quality is excellent with no calcification. The annulus is moderately dilated at 38mm but should be addressable with an annuloplasty ring.",
                        type: "support",
                        reactions: ["surgeon:agree"],
                        delay: 3000
                    },
                    {
                        speaker: "anesthesia",
                        message: "From a perioperative risk standpoint, the STS score of 1.8% puts him in the low-risk category. His diabetes is well-controlled with an A1c of 6.8%. No pulmonary or renal issues. He should tolerate surgery well.",
                        type: "support",
                        reactions: ["surgeon:agree", "imaging:agree"],
                        delay: 3500
                    },
                    {
                        speaker: "interventional",
                        message: "While I agree surgery seems appropriate, should we discuss transcatheter options? The anatomy appears suitable for MitraClip, and some patients prefer to avoid sternotomy. What are the patient's preferences?",
                        type: "challenge",
                        reactions: ["surgeon:thinking"],
                        delay: 3000
                    },
                    {
                        speaker: "coordinator",
                        message: "The patient did express initial concerns about open surgery. However, after discussing the minimally invasive approach with a small right thoracotomy, he seemed more receptive. His main goal is to return to his active lifestyle - he plays golf three times a week.",
                        type: "neutral",
                        reactions: [],
                        delay: 3500
                    },
                    {
                        speaker: "surgeon",
                        message: "That's an important point about lifestyle. With this anatomy, I can achieve a >95% repair rate through a mini-thoracotomy. The durability data shows 90% freedom from reoperation at 15 years. MitraClip has higher residual MR rates and less durability data.",
                        type: "support",
                        reactions: ["imaging:agree", "anesthesia:agree"],
                        delay: 4000
                    },
                    {
                        speaker: "heartfailure",
                        message: "The LV is already showing early remodeling with an LVEDV of 185ml. We need definitive treatment before further deterioration. The guidelines give a Class I recommendation for surgery when repair likelihood is >95% and surgical risk is low.",
                        type: "support",
                        reactions: ["surgeon:agree", "imaging:agree"],
                        delay: 3500
                    },
                    {
                        speaker: "interventional",
                        message: "Those are compelling arguments. Given the excellent anatomy, low surgical risk, and need for durable repair in this relatively young patient, I agree surgery is the best option. MitraClip should be reserved for higher-risk patients.",
                        type: "support",
                        reactions: ["surgeon:agree", "heartfailure:agree"],
                        delay: 3000
                    },
                    {
                        speaker: "imaging",
                        message: "I should add that the exercise echo showed his PAP rising to 58mmHg, suggesting hemodynamic consequences despite being relatively asymptomatic. This supports early intervention.",
                        type: "support",
                        reactions: ["heartfailure:agree", "anesthesia:agree"],
                        delay: 2500
                    },
                    {
                        speaker: "surgeon",
                        message: "Excellent point. So we have consensus for minimally invasive mitral repair? I'll plan for P2 resection with a 32mm annuloplasty ring. Expected pump time around 90 minutes.",
                        type: "neutral",
                        reactions: ["all:agree"],
                        delay: 3000
                    }
                ],
                decisionTree: [
                    {
                        id: "anatomy",
                        title: "Anatomical Assessment",
                        description: "Isolated P2 prolapse with good tissue quality",
                        value: "Favorable for repair",
                        borderColor: "#11998e"
                    },
                    {
                        id: "risk",
                        title: "Surgical Risk",
                        description: "STS Score 1.8%, no major comorbidities",
                        value: "Low risk",
                        borderColor: "#11998e"
                    },
                    {
                        id: "durability",
                        title: "Expected Durability",
                        description: ">95% repair success, 90% freedom from reoperation at 15 years",
                        value: "Excellent",
                        borderColor: "#667eea"
                    },
                    {
                        id: "patient",
                        title: "Patient Factors",
                        description: "Active lifestyle, willing for mini-thoracotomy",
                        value: "Suitable",
                        borderColor: "#11998e"
                    }
                ],
                consensusProgress: [0, 20, 35, 50, 45, 60, 75, 85, 92, 95, 98, 100],
                finalDecision: "Minimally invasive mitral valve repair with P2 resection and annuloplasty",
                rationale: "For this patient with isolated P2 prolapse, preserved LV function, and low surgical risk (STS 1.8%), minimally invasive mitral repair offers the best long-term outcome with >95% repair success rate and excellent durability.",
                learningPoints: [
                    "Isolated P2 prolapse has the highest repair success rates (>95%) in experienced centers",
                    "Early intervention preserves LV function and prevents adverse remodeling", 
                    "Exercise echocardiography can unmask hemodynamic consequences in 'asymptomatic' patients",
                    "Minimally invasive approaches reduce morbidity while maintaining repair quality",
                    "Patient lifestyle goals should be considered in treatment planning",
                    "Multidisciplinary consensus improves patient outcomes and satisfaction"
                ]
            }
            // Additional cases can be added here
        ];

        // Global State
        let currentCase = null;
        let currentMode = 'guided';
        let currentRole = null;
        let currentView = 'discussion';
        let discussionIndex = 0;
        let discussionTimer = null;
        let discussionPaused = false;
        let discussionSpeed = 1;
        let secondsElapsed = 0;
        let timerInterval = null;
        let consensusLevel = 0;
        let selectedResponse = null;
        let teamVotes = {};

        // Start Application
        function startApplication() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.opacity = '0';
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                    const mainApp = document.getElementById('mainApp');
                    if (mainApp) {
                        mainApp.style.display = 'block';
                    }
                    createParticles();
                    showRoleSelection();
                }, 800);
            }
        }

        // Role Selection Modal
        function showRoleSelection() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-icon">üë•</div>
                        <h2 class="modal-title">Choose Your Role</h2>
                        <p class="modal-subtitle">Select your specialty and learning mode</p>
                    </div>
                    
                    <div class="feedback-section">
                        <div class="feedback-title">
                            <span>üé≠</span>
                            <span>Select Your Specialty</span>
                        </div>
                        <div class="response-options">
                            <div class="response-option" onclick="setRole('surgeon')">
                                <div class="response-type type-support">Surgeon</div>
                                <div class="response-text">Lead surgical discussions and advocate for operative interventions</div>
                                <div class="response-confidence">
                                    <span class="confidence-label">Experience: 20 years</span>
                                </div>
                            </div>
                            <div class="response-option" onclick="setRole('interventional')">
                                <div class="response-type type-question">Interventional</div>
                                <div class="response-text">Champion transcatheter therapies and minimally invasive approaches</div>
                                <div class="response-confidence">
                                    <span class="confidence-label">Experience: 15 years</span>
                                </div>
                            </div>
                            <div class="response-option" onclick="setRole('imaging')">
                                <div class="response-type type-data">Imaging</div>
                                <div class="response-text">Provide detailed anatomical assessments and guide procedural planning</div>
                                <div class="response-confidence">
                                    <span class="confidence-label">Experience: 18 years</span>
                                </div>
                            </div>
                            <div class="response-option" onclick="setRole('anesthesia')">
                                <div class="response-type type-challenge">Anesthesia</div>
                                <div class="response-text">Assess perioperative risks and optimize patient safety</div>
                                <div class="response-confidence">
                                    <span class="confidence-label">Experience: 22 years</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="feedback-section">
                        <div class="feedback-title">
                            <span>üéÆ</span>
                            <span>Select Learning Mode</span>
                        </div>
                        <div class="modal-actions">
                            <button class="modal-btn secondary" onclick="startSimulation('guided')">
                                Guided Learning
                            </button>
                            <button class="modal-btn primary" onclick="startSimulation('practice')">
                                Practice Mode
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function setRole(role) {
            currentRole = role;
            document.querySelectorAll('.response-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.response-option').classList.add('selected');
        }

        function startSimulation(mode) {
            currentMode = mode;
            if (!currentRole && mode === 'practice') {
                alert('Please select a role for practice mode');
                return;
            }
            
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            const modeBadge = document.getElementById('modeBadge');
            if (modeBadge) {
                modeBadge.textContent = mode === 'guided' ? 'Guided Learning' : 'Practice Mode';
            }
            
            if (mode === 'practice') {
                const interactionPanel = document.getElementById('interactionPanel');
                if (interactionPanel) {
                    interactionPanel.style.display = 'block';
                }
            }
            
            loadCase(0);
        }

        // Load Case
        function loadCase(caseIndex) {
            currentCase = casesDatabase[caseIndex];
            discussionIndex = 0;
            consensusLevel = 0;
            secondsElapsed = 0;
            teamVotes = {};
            
            // Update patient information
            updatePatientPanel();
            
            // Setup team circle
            setupTeamCircle();
            
            // Setup vote distribution
            setupVoteDistribution();
            
            // Setup decision tree
            setupDecisionTree();
            
            // Start timer
            startTimer();
            
            // Begin discussion
            startDiscussion();
        }

        // Update Patient Panel
        function updatePatientPanel() {
            const panel = document.getElementById('patientPanel');
            if (!panel || !currentCase) return;
            
            const patient = currentCase.patient;
            const data = currentCase.clinicalData;
            
            panel.innerHTML = `
                <div class="patient-header">
                    <div class="patient-photo">${patient.photo}</div>
                    <div class="patient-name">${patient.name}</div>
                    <div class="patient-meta">
                        <div class="meta-item">
                            <span>üë§</span>
                            <span>${patient.age} years</span>
                        </div>
                        <div class="meta-item">
                            <span>‚ôÇÔ∏è</span>
                            <span>${patient.gender}</span>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="section-icon">‚ù§Ô∏è</div>
                            <span>Hemodynamics</span>
                        </div>
                        <span class="section-expand" onclick="expandSection('hemodynamics')">‚§µÔ∏è</span>
                    </div>
                    <div class="data-grid">
                        <div class="data-item" onclick="showDataDetails('ef')">
                            <div class="data-label">Ejection Fraction</div>
                            <div class="data-value ${data.hemodynamics.ef.value >= 50 ? 'normal' : 'warning'}">${data.hemodynamics.ef.value}<span class="data-unit">%</span></div>
                            <div class="data-trend ${data.hemodynamics.ef.trend === 'up' ? 'trend-up' : data.hemodynamics.ef.trend === 'down' ? 'trend-down' : ''}">
                                ${data.hemodynamics.ef.trend === 'up' ? '‚Üë' : data.hemodynamics.ef.trend === 'down' ? '‚Üì' : '‚Üí'}
                            </div>
                        </div>
                        <div class="data-item" onclick="showDataDetails('lvedv')">
                            <div class="data-label">LVEDV</div>
                            <div class="data-value ${data.hemodynamics.lvedv.value > 170 ? 'warning' : 'normal'}">${data.hemodynamics.lvedv.value}<span class="data-unit">ml</span></div>
                            <div class="data-trend ${data.hemodynamics.lvedv.trend === 'up' ? 'trend-up' : ''}">
                                ${data.hemodynamics.lvedv.trend === 'up' ? '‚Üë' : '‚Üí'}
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">LVESV</div>
                            <div class="data-value normal">${data.hemodynamics.lvesv.value}<span class="data-unit">ml</span></div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">LA Volume</div>
                            <div class="data-value ${data.hemodynamics.la_volume.value > 90 ? 'warning' : 'normal'}">${data.hemodynamics.la_volume.value}<span class="data-unit">ml</span></div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">PAP</div>
                            <div class="data-value ${data.hemodynamics.pap.value > 35 ? 'warning' : 'normal'}">${data.hemodynamics.pap.value}<span class="data-unit">mmHg</span></div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Cardiac Index</div>
                            <div class="data-value normal">${data.hemodynamics.ci.value}<span class="data-unit">L/min/m¬≤</span></div>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="section-icon">ü´Ä</div>
                            <span>Valve Assessment</span>
                        </div>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">MR Severity</div>
                            <div class="data-value critical">${data.valve.mr_severity}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Mechanism</div>
                            <div class="data-value">${data.valve.mechanism}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">ERO Area</div>
                            <div class="data-value critical">${data.valve.ero}<span class="data-unit">cm¬≤</span></div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Reg Volume</div>
                            <div class="data-value critical">${data.valve.reg_volume}<span class="data-unit">ml</span></div>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="section-icon">üìä</div>
                            <span>Risk Assessment</span>
                        </div>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">STS Score</div>
                            <div class="data-value ${data.risk.sts < 4 ? 'normal' : data.risk.sts < 8 ? 'warning' : 'critical'}">${data.risk.sts}<span class="data-unit">%</span></div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">EuroSCORE II</div>
                            <div class="data-value ${data.risk.euroscore < 4 ? 'normal' : 'warning'}">${data.risk.euroscore}<span class="data-unit">%</span></div>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="section-icon">üè•</div>
                            <span>Clinical Status</span>
                        </div>
                    </div>
                    <div class="status-badges">
                        <div class="status-badge active">NYHA ${data.status.nyha}</div>
                        ${data.status.diabetes ? '<div class="status-badge active">Diabetes</div>' : ''}
                        ${!data.status.cad ? '<div class="status-badge inactive">No CAD</div>' : ''}
                        ${!data.status.afib ? '<div class="status-badge inactive">No AFib</div>' : ''}
                    </div>
                </div>
            `;
        }

        // Setup Team Circle
        function setupTeamCircle() {
            const circle = document.getElementById('teamCircle');
            if (!circle || !currentCase) return;
            
            const centerX = circle.offsetWidth / 2;
            const centerY = 225;
            const radius = 180;
            
            // Clear existing members
            circle.querySelectorAll('.team-member').forEach(m => m.remove());
            
            currentCase.teamMembers.forEach((member, index) => {
                const angle = member.position.angle * Math.PI / 180 - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.id = `member-${member.id}`;
                memberDiv.style.left = (x - 70) + 'px';
                memberDiv.style.top = (y - 90) + 'px';
                
                const opinionClass = `opinion-${member.opinion}`;
                const opinionSymbol = member.opinion === 'surgery' ? 'S' : 
                                     member.opinion === 'transcatheter' ? 'T' :
                                     member.opinion === 'medical' ? 'M' : '?';
                
                memberDiv.innerHTML = `
                    <div class="member-avatar ${member.id === currentRole ? 'selected' : ''}" id="avatar-${member.id}" onclick="showMemberDetails('${member.id}')">
                        <div class="member-emoji">${member.emoji}</div>
                        <div class="member-role">${member.role}</div>
                        <div class="opinion-badge ${opinionClass}" id="opinion-${member.id}">${opinionSymbol}</div>
                        <div class="member-tooltip">${member.experience}</div>
                    </div>
                    <div class="member-name">${member.name}</div>
                    <div class="member-status" id="status-${member.id}"></div>
                `;
                
                circle.appendChild(memberDiv);
                
                // Initialize team votes
                teamVotes[member.id] = member.opinion;
            });
        }

        // Setup Vote Distribution
        function setupVoteDistribution() {
            const voteDistribution = document.getElementById('voteDistribution');
            if (!voteDistribution) return;
            
            voteDistribution.innerHTML = `
                <div class="vote-card" onclick="showVoteDetails('surgery')">
                    <div class="vote-icon surgery">üî™</div>
                    <div class="vote-count" id="voteSurgery">0</div>
                    <div class="vote-label">Surgery</div>
                    <div class="vote-members" id="voteMembersSurgery"></div>
                </div>
                <div class="vote-card" onclick="showVoteDetails('transcatheter')">
                    <div class="vote-icon transcatheter">ü©∫</div>
                    <div class="vote-count" id="voteTranscatheter">0</div>
                    <div class="vote-label">Transcatheter</div>
                    <div class="vote-members" id="voteMembersTranscatheter"></div>
                </div>
                <div class="vote-card" onclick="showVoteDetails('medical')">
                    <div class="vote-icon medical">üíä</div>
                    <div class="vote-count" id="voteMedical">0</div>
                    <div class="vote-label">Medical</div>
                    <div class="vote-members" id="voteMembersMedical"></div>
                </div>
            `;
            
            updateVotes();
        }

        // Setup Decision Tree
        function setupDecisionTree() {
            const treeNodes = document.getElementById('treeNodes');
            if (!treeNodes || !currentCase) return;
            
            treeNodes.innerHTML = '';
            currentCase.decisionTree.forEach(node => {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                nodeDiv.style.borderLeftColor = node.borderColor;
                nodeDiv.innerHTML = `
                    <div class="node-icon" style="background: ${node.borderColor}20; color: ${node.borderColor};">
                        ${node.id === 'anatomy' ? 'ü´Ä' : node.id === 'risk' ? 'üìä' : node.id === 'durability' ? '‚è±Ô∏è' : 'üë§'}
                    </div>
                    <div class="node-content">
                        <div class="node-title">${node.title}</div>
                        <div class="node-description">${node.description}</div>
                    </div>
                    <div class="node-value">${node.value}</div>
                `;
                treeNodes.appendChild(nodeDiv);
            });
        }

        // Start Timer
        function startTimer() {
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const minutes = Math.floor(secondsElapsed / 60);
                const seconds = secondsElapsed % 60;
                const timerValue = document.getElementById('timerValue');
                if (timerValue) {
                    timerValue.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Start Discussion
        function startDiscussion() {
            const messages = document.getElementById('discussionMessages');
            if (messages) {
                messages.innerHTML = '';
            }
            
            if (currentMode === 'guided') {
                runGuidedDiscussion();
            } else {
                runPracticeDiscussion();
            }
        }

        // Guided Discussion
        function runGuidedDiscussion() {
            if (!currentCase) return;
            
            const discussion = currentCase.discussion;
            
            function showNextMessage() {
                if (discussionPaused) {
                    discussionTimer = setTimeout(showNextMessage, 500);
                    return;
                }
                
                if (discussionIndex < discussion.length) {
                    const msg = discussion[discussionIndex];
                    const speaker = currentCase.teamMembers.find(m => m.id === msg.speaker);
                    
                    if (!speaker) {
                        discussionIndex++;
                        showNextMessage();
                        return;
                    }
                    
                    // Animate speaker
                    document.querySelectorAll('.member-avatar').forEach(a => {
                        a.classList.remove('speaking', 'thinking');
                    });
                    const avatar = document.getElementById(`avatar-${speaker.id}`);
                    if (avatar) {
                        avatar.classList.add('speaking');
                    }
                    
                    // Show thinking status
                    const status = document.getElementById(`status-${speaker.id}`);
                    if (status) {
                        status.innerHTML = 
                            '<div class="thinking-dots"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div>';
                    }
                    
                    setTimeout(() => {
                        if (status) {
                            status.innerHTML = '';
                        }
                        addMessage(speaker, msg.message, msg.type, msg.reactions);
                        
                        // Update consensus
                        if (currentCase.consensusProgress[discussionIndex]) {
                            updateConsensus(currentCase.consensusProgress[discussionIndex]);
                        }
                        
                        // Update votes based on reactions
                        processReactions(msg.reactions);
                        updateVotes();
                        
                        discussionIndex++;
                        discussionTimer = setTimeout(showNextMessage, (msg.delay || 3000) / discussionSpeed);
                    }, 1500 / discussionSpeed);
                } else {
                    showCaseComplete();
                }
            }
            
            showNextMessage();
        }

        // Add Message
        function addMessage(speaker, text, type, reactions) {
            const messages = document.getElementById('discussionMessages');
            if (!messages) return;
            
            const avatarClass = speaker.id;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="message-avatar ${avatarClass}">${speaker.emoji}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${speaker.name}</span>
                        <span class="message-role">${speaker.role}</span>
                        <span class="message-time">${getCurrentTime()}</span>
                    </div>
                    <div class="message-text ${type}">${text}</div>
                    <div class="message-reactions">
                        <button class="reaction-btn" onclick="reactToMessage(this, 'agree')">üëç Agree</button>
                        <button class="reaction-btn" onclick="reactToMessage(this, 'disagree')">üëé Disagree</button>
                        <button class="reaction-btn" onclick="reactToMessage(this, 'question')">‚ùì Question</button>
                    </div>
                </div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // Process Reactions
        function processReactions(reactions) {
            if (!reactions || !currentCase) return;
            
            reactions.forEach(reaction => {
                const [memberId, reactionType] = reaction.split(':');
                
                if (memberId === 'all') {
                    currentCase.teamMembers.forEach(member => {
                        updateMemberState(member.id, reactionType);
                    });
                } else {
                    updateMemberState(memberId, reactionType);
                }
            });
        }

        // Update Member State
        function updateMemberState(memberId, state) {
            const avatar = document.getElementById(`avatar-${memberId}`);
            if (!avatar) return;
            
            avatar.classList.remove('agrees', 'disagrees', 'thinking');
            
            if (state === 'agree') {
                avatar.classList.add('agrees');
            } else if (state === 'disagree') {
                avatar.classList.add('disagrees');
            } else if (state === 'thinking') {
                avatar.classList.add('thinking');
            }
            
            // Update vote if agreeing
            if (state === 'agree' && currentCase) {
                const currentSpeaker = currentCase.discussion[discussionIndex - 1]?.speaker;
                if (currentSpeaker) {
                    const speakerMember = currentCase.teamMembers.find(m => m.id === currentSpeaker);
                    if (speakerMember && speakerMember.opinion !== 'undecided') {
                        teamVotes[memberId] = speakerMember.opinion;
                        updateOpinionBadge(memberId, speakerMember.opinion);
                    }
                }
            }
        }

        // Update Opinion Badge
        function updateOpinionBadge(memberId, opinion) {
            const badge = document.getElementById(`opinion-${memberId}`);
            if (!badge) return;
            
            badge.className = `opinion-badge opinion-${opinion}`;
            badge.textContent = opinion === 'surgery' ? 'S' :
                               opinion === 'transcatheter' ? 'T' :
                               opinion === 'medical' ? 'M' : '?';
        }

        // Update Consensus
        function updateConsensus(level) {
            consensusLevel = level;
            
            const elements = {
                percent: document.getElementById('consensusPercent'),
                value: document.getElementById('consensusValue'),
                fill: document.getElementById('consensusFill'),
                status: document.getElementById('consensusStatus')
            };
            
            if (elements.percent) elements.percent.textContent = level + '%';
            if (elements.value) elements.value.textContent = level + '%';
            if (elements.fill) {
                elements.fill.style.width = level + '%';
                elements.fill.textContent = 
                    level < 30 ? 'Building...' :
                    level < 60 ? 'Discussing...' :
                    level < 85 ? 'Aligning...' : 'Consensus Reached';
            }
            if (elements.status) {
                elements.status.textContent = 
                    level < 30 ? 'Disagreement' :
                    level < 60 ? 'Active Discussion' :
                    level < 85 ? 'Building Agreement' : 'Consensus Achieved';
            }
        }

        // Update Votes
        function updateVotes() {
            let surgery = 0, transcatheter = 0, medical = 0;
            const surgeryMembers = [], transcatheterMembers = [], medicalMembers = [];
            
            Object.entries(teamVotes).forEach(([memberId, vote]) => {
                const member = currentCase?.teamMembers.find(m => m.id === memberId);
                if (!member) return;
                
                if (vote === 'surgery') {
                    surgery++;
                    surgeryMembers.push(member.emoji);
                } else if (vote === 'transcatheter') {
                    transcatheter++;
                    transcatheterMembers.push(member.emoji);
                } else if (vote === 'medical') {
                    medical++;
                    medicalMembers.push(member.emoji);
                }
            });
            
            // Update counts
            const voteSurgery = document.getElementById('voteSurgery');
            const voteTranscatheter = document.getElementById('voteTranscatheter');
            const voteMedical = document.getElementById('voteMedical');
            
            if (voteSurgery) voteSurgery.textContent = surgery;
            if (voteTranscatheter) voteTranscatheter.textContent = transcatheter;
            if (voteMedical) voteMedical.textContent = medical;
            
            // Update member icons
            const voteMembersSurgery = document.getElementById('voteMembersSurgery');
            const voteMembersTranscatheter = document.getElementById('voteMembersTranscatheter');
            const voteMembersMedical = document.getElementById('voteMembersMedical');
            
            if (voteMembersSurgery) {
                voteMembersSurgery.innerHTML = surgeryMembers.map(e => 
                    `<div class="vote-member-mini">${e}</div>`
                ).join('');
            }
            if (voteMembersTranscatheter) {
                voteMembersTranscatheter.innerHTML = transcatheterMembers.map(e => 
                    `<div class="vote-member-mini">${e}</div>`
                ).join('');
            }
            if (voteMembersMedical) {
                voteMembersMedical.innerHTML = medicalMembers.map(e => 
                    `<div class="vote-member-mini">${e}</div>`
                ).join('');
            }
        }

        // Show Case Complete
        function showCaseComplete() {
            clearInterval(timerInterval);
            clearTimeout(discussionTimer);
            
            setTimeout(() => {
                const modal = document.getElementById('feedbackModal');
                if (!modal || !currentCase) return;
                
                modal.style.display = 'block';
                
                // Update modal content
                const scoreDisplay = document.getElementById('scoreDisplay');
                const finalDecision = document.getElementById('finalDecision');
                const clinicalRationale = document.getElementById('clinicalRationale');
                const learningPoints = document.getElementById('learningPoints');
                
                if (scoreDisplay) scoreDisplay.textContent = '92%';
                if (finalDecision) finalDecision.textContent = currentCase.finalDecision;
                if (clinicalRationale) clinicalRationale.textContent = currentCase.rationale;
                
                if (learningPoints) {
                    const pointsHtml = currentCase.learningPoints.map(point => `
                        <li class="learning-point">
                            <div class="point-icon">‚úì</div>
                            <div class="point-text">${point}</div>
                        </li>
                    `).join('');
                    learningPoints.innerHTML = pointsHtml;
                }
            }, 2000);
        }

        // Interactive Functions
        function setView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide panels
            const discussionArea = document.getElementById('discussionArea');
            const consensusPanel = document.getElementById('consensusPanel');
            const decisionTree = document.getElementById('decisionTree');
            
            if (discussionArea) discussionArea.style.display = view === 'discussion' ? 'block' : 'none';
            if (consensusPanel) consensusPanel.style.display = view === 'voting' ? 'block' : 'none';
            if (decisionTree) decisionTree.style.display = view === 'decision' ? 'block' : 'none';
            
            if (view === 'evidence') {
                showEvidenceModal();
            }
        }

        function pauseDiscussion() {
            discussionPaused = !discussionPaused;
            const btn = event.target;
            btn.textContent = discussionPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
        }

        function speedUpDiscussion() {
            discussionSpeed = discussionSpeed === 1 ? 2 : discussionSpeed === 2 ? 3 : 1;
            const btn = event.target;
            btn.textContent = discussionSpeed === 1 ? '‚è©' : discussionSpeed === 2 ? '‚è©‚è©' : '‚è©‚è©‚è©';
        }

        function jumpToConflict() {
            // Jump to first challenge/conflict in discussion
            if (!currentCase) return;
            
            const conflictIndex = currentCase.discussion.findIndex(msg => msg.type === 'challenge');
            if (conflictIndex !== -1 && conflictIndex > discussionIndex) {
                discussionIndex = conflictIndex - 1;
            }
        }

        function quickAction(action) {
            console.log('Quick action:', action);
            // Implement quick action responses
        }

        function reactToMessage(btn, reaction) {
            btn.classList.toggle('active');
            // Implement message reactions
        }

        function showMemberDetails(memberId) {
            const member = currentCase?.teamMembers.find(m => m.id === memberId);
            if (!member) return;
            
            console.log('Member details:', member);
            // Could show a modal with detailed member information
        }

        function showVoteDetails(voteType) {
            console.log('Vote details:', voteType);
            // Could show detailed breakdown of votes
        }

        function showConsensusDetails() {
            console.log('Consensus details');
            // Could show detailed consensus breakdown
        }

        function showDataDetails(dataType) {
            console.log('Data details:', dataType);
            // Could show trending data or detailed explanations
        }

        function expandSection(section) {
            console.log('Expand section:', section);
            // Could expand/collapse sections
        }

        function showEvidenceModal() {
            // Create evidence modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-icon">üìö</div>
                        <h2 class="modal-title">Clinical Evidence</h2>
                        <p class="modal-subtitle">Guidelines and supporting literature</p>
                    </div>
                    
                    <div class="feedback-section">
                        <div class="feedback-title">
                            <span>üìñ</span>
                            <span>Current Guidelines</span>
                        </div>
                        <div class="feedback-content">
                            <strong>2020 ACC/AHA Guidelines for Valvular Heart Disease:</strong><br>
                            Class I recommendation for mitral valve surgery when:<br>
                            ‚Ä¢ Symptomatic severe primary MR<br>
                            ‚Ä¢ Asymptomatic severe MR with LVEF ‚â§60% or LVESD ‚â•40mm<br>
                            ‚Ä¢ Repair success likelihood >95% with expected mortality <1%
                        </div>
                    </div>
                    
                    <div class="feedback-section">
                        <div class="feedback-title">
                            <span>üìä</span>
                            <span>Key Studies</span>
                        </div>
                        <div class="feedback-content">
                            ‚Ä¢ <strong>COAPT Trial:</strong> MitraClip in functional MR with HF<br>
                            ‚Ä¢ <strong>MITRA-FR:</strong> Different patient selection criteria<br>
                            ‚Ä¢ <strong>Surgical series:</strong> >95% repair rate for isolated P2 prolapse
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn primary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Helper Functions
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function reviewCase() {
            const modal = document.getElementById('feedbackModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function nextCase() {
            const modal = document.getElementById('feedbackModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // In real app, would load next case
            // For now, reload the same case
            loadCase(0);
        }
    </script>
</body>
</html>
